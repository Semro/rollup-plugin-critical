{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import {Plugin} from 'rollup';\nimport * as path from 'path';\nimport {generate} from 'critical';\n\nconst criticalSuffix = '_critical.min.css';\n\n/**\n * Default `criticalConfig` passed in to `critical`\n */\nconst defaultCriticalConfig: Partial<CriticalConfig> = {\n  inline: false,\n  extract: false,\n  width: 1200,\n  height: 1200,\n  penthouse: {\n    blockJSRequests: false\n  }\n};\n\n/**\n * [Vite.js](https://vitejs.dev/) & [Rollup](https://rollupjs.org/) plugin for generating critical CSS\n * that uses the [critical](https://github.com/addyosmani/critical) generator under the hood.\n *\n * @param {CriticalPluginConfig} pluginConfig - the plugin configuration object\n * @param {Function} callback - callback upon completion of the critical CSS generation\n * @constructor\n */\nexport function PluginCritical(pluginConfig: CriticalPluginConfig, callback?: CriticalPluginCallback): Plugin {\n  return {\n    name: 'critical',\n    async writeBundle(outputOptions, bundle) {\n      const css: Array<string> = [];\n      // Find all of the generated CSS assets\n      for (const chunk of Object.values(bundle)) {\n        if (chunk.type === 'asset' && chunk.fileName.endsWith('.css')) {\n          const cssFile = path.join(outputOptions.dir || '', chunk.fileName);\n          css.push(cssFile);\n        }\n      }\n      // If we have no CSS, skip bundle\n      if (!css.length) {\n        return;\n      }\n      // Iterate through the pages\n      for (const page of pluginConfig.criticalPages) {\n        const criticalBase = pluginConfig.criticalBase;\n        const criticalSrc = pluginConfig.criticalUrl + page.uri;\n        // If inline is set to true, use HTML as target, otherwise CSS with suffix\n        const criticalTarget = (pluginConfig.criticalConfig && pluginConfig.criticalConfig.inline == true) ? page.template + \".html\" : page.template + criticalSuffix;\n        // Merge in our options\n        const options = Object.assign(\n            { css },\n            defaultCriticalConfig,\n            {\n              base: criticalBase,\n              src: criticalSrc,\n              target: criticalTarget,\n            },\n            pluginConfig.criticalConfig\n        );\n        // Generate the Critical CSS\n        console.log(`Generating critical CSS from ${criticalSrc} to ${criticalTarget}`);\n        await generate(options, (err: string) => {\n          if (err) {\n            console.error(err);\n          }\n          if (callback) {\n            callback(err);\n          }\n        });\n      }\n    }\n  }\n}\n"],"mappings":"AACA,UAAYA,MAAU,OACtB,OAAQ,YAAAC,MAAe,WAEvB,IAAMC,EAAiB,oBAKjBC,EAAiD,CACrD,OAAQ,GACR,QAAS,GACT,MAAO,KACP,OAAQ,KACR,UAAW,CACT,gBAAiB,EACnB,CACF,EAUO,SAASC,EAAeC,EAAoCC,EAA2C,CAC5G,MAAO,CACL,KAAM,WACN,MAAM,YAAYC,EAAeC,EAAQ,CACvC,IAAMC,EAAqB,CAAC,EAE5B,QAAWC,KAAS,OAAO,OAAOF,CAAM,EACtC,GAAIE,EAAM,OAAS,SAAWA,EAAM,SAAS,SAAS,MAAM,EAAG,CAC7D,IAAMC,EAAe,OAAKJ,EAAc,KAAO,GAAIG,EAAM,QAAQ,EACjED,EAAI,KAAKE,CAAO,CAClB,CAGF,GAAI,EAACF,EAAI,OAIT,QAAWG,KAAQP,EAAa,cAAe,CAC7C,IAAMQ,EAAeR,EAAa,aAC5BS,EAAcT,EAAa,YAAcO,EAAK,IAE9CG,EAAkBV,EAAa,gBAAkBA,EAAa,eAAe,QAAU,GAAQO,EAAK,SAAW,QAAUA,EAAK,SAAWV,EAEzIc,EAAU,OAAO,OACnB,CAAE,IAAAP,CAAI,EACNN,EACA,CACE,KAAMU,EACN,IAAKC,EACL,OAAQC,CACV,EACAV,EAAa,cACjB,EAEA,QAAQ,IAAI,gCAAgCS,QAAkBC,GAAgB,EAC9E,MAAMd,EAASe,EAAUC,GAAgB,CACnCA,GACF,QAAQ,MAAMA,CAAG,EAEfX,GACFA,EAASW,CAAG,CAEhB,CAAC,CACH,CACF,CACF,CACF","names":["path","generate","criticalSuffix","defaultCriticalConfig","PluginCritical","pluginConfig","callback","outputOptions","bundle","css","chunk","cssFile","page","criticalBase","criticalSrc","criticalTarget","options","err"]}